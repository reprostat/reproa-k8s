<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>reproa-k8s</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

<div class="spinner" id="spinner"></div>

<h2>Folder Upload</h2>
<form id="uploadForm" enctype="multipart/form-data">
  <label for="files">Select folder to upload:</label>
  <input type="file" name="files[]" id="files" multiple webkitdirectory required>
  <input type="submit" value="Upload Folder">
</form>

<hr>

<h2>Uploaded Files</h2>
<div class="file-browser">
  <!-- Breadcrumb for navigation -->
  <div id="breadcrumb"></div>

  <hr style="margin-bottom: 0px;">

  <!-- File and folder list -->
  <ul id="file-list"></ul>
</div>

<hr>

<div class="button-group-container">
  <!-- Button to trigger clearing storage -->
  <button id="clearStorageBtn" class="button-group-style">Clear Storage</button>
  <!-- Button to trigger data processing -->
  <button id="processFilesBtn" class="button-group-style">Process Files</button>
</div>

<!-- Floating brainwave circles -->
<div>
    <span class="circle"></span>
    <span class="circle"></span>
</div>

<script>
  let currentPath=''
  const uploadForm = document.getElementById('uploadForm');
  const spinner = document.getElementById('spinner');
  const body = document.body;

  uploadForm.addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission

    const formData = new FormData(this);

    // Show spinner and add blur effect
    spinner.style.display = 'block';
    body.classList.add('blurred');

    fetch('/api/storage/upload', {
      method: 'POST',
      body: formData
    })
    .then(response => response.json())
    .then(data => {
      console.log('Files uploaded successfully:', data);

      spinner.style.display = 'none';
      body.classList.remove('blurred');

      window.location.reload(); // Reload to show updated file list
    })
    .catch(error => {
      console.error('Error uploading folder:', error);

      spinner.style.display = 'none';
      body.classList.remove('blurred');
    });
  });

  // Function to fetch and display files and folders
  function fetchFolderContents(path) {
    fetch(`/api/storage/files/${path}`)
      .then(response => response.json())
      .then(data => {
        if (data.error) {
          alert(data.error);
        } else {
          displayFiles(data);
        }
      });
  }

  // Function to display files and folders in the list
  function displayFiles(items) {
    const fileList = document.getElementById('file-list');
    fileList.innerHTML = '';

    items.forEach(item => {
      const li = document.createElement('li');
      li.textContent = item.name;
      
      if (item.type === 'folder') {
        li.classList.add('folder');
        li.addEventListener('click', () => navigateToFolder(item.name));
      } else {
        li.classList.add('file');
        li.addEventListener('click', () => downloadFile(item.name));
      }

      fileList.appendChild(li);
    });

    updateBreadcrumb();
  }

  // Function to navigate into a folder
  function navigateToFolder(folderName) {
    currentPath += (currentPath ? '/' : '') + folderName;
    fetchFolderContents(currentPath);
  }

  // Function to go back in the breadcrumb
  function navigateToPath(pathIndex) {
    const pathArray = currentPath.split('/');
    currentPath = pathArray.slice(0, pathIndex + 1).join('/');
    fetchFolderContents(currentPath);
  }

  // Function to update breadcrumb navigation
  function updateBreadcrumb() {
    const breadcrumb = document.getElementById('breadcrumb');
    breadcrumb.innerHTML = '';

    // Prefix
    const span = document.createElement('span');
    span.textContent = 'Path';
    span.classList.add('breadcrumb-item');
    breadcrumb.appendChild(span);

    const pathArray = currentPath.split('/');
    pathArray.forEach((dir, index) => {
      const span = document.createElement('span');
      span.textContent = dir || 'storage';
      span.classList.add('breadcrumb-item');
      span.addEventListener('click', () => navigateToPath(index));
      breadcrumb.appendChild(span);
    });
  }

  // Function to download a file
  function downloadFile(fileName) {
    const downloadUrl = `/api/storage/download/${currentPath ? currentPath + '/' : ''}${fileName}`;
    window.location.href = downloadUrl;
  }

  document.getElementById('clearStorageBtn').addEventListener('click', function() {
    // Show spinner and add blur effect
    spinner.style.display = 'block';
    body.classList.add('blurred');

    // Send a request to trigger file processing
    fetch('/api/storage/clear', {
      method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
      console.log('Storage cleared');

      spinner.style.display = 'none';
      body.classList.remove('blurred');

      // Optionally refresh the page to reflect the results
      window.location.reload();
    })
    .catch(error => {
      console.error('Error clearing storage:', error);

      spinner.style.display = 'none';
      body.classList.remove('blurred');
    });
  });

  document.getElementById('processFilesBtn').addEventListener('click', function() {
    // Show spinner and add blur effect
    spinner.style.display = 'block';
    body.classList.add('blurred');

    // Send a request to trigger file processing
    fetch('/api/processor/process-data', {
      method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
      console.log('Processing complete:', data);

      spinner.style.display = 'none';
      body.classList.remove('blurred');

      // Optionally refresh the page to reflect the results
      window.location.reload();
    })
    .catch(error => {
      console.error('Error processing files:', error);

      spinner.style.display = 'none';
      body.classList.remove('blurred');
    });
  });
  // Initial load of root folder
  fetchFolderContents('');

</script>

</body>
</html>
